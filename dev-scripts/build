#!/usr/bin/env bash

set -eo pipefail
set -x

source dev-scripts/prepare-build-env

BUILD_ARGS=()
BUILD_ARGS+=("--build-arg=VERSION=${TAG}")
BUILD_ARGS+=("--build-arg=COMMIT=${COMMIT}")
BUILD_ARGS+=("--build-arg=ARCH=${ARCH}")
BUILD_ARGS+=("--build-arg=CATTLE_RANCHER_WEBHOOK_VERSION=${CATTLE_RANCHER_WEBHOOK_VERSION}")
BUILD_ARGS+=("--build-arg=CATTLE_REMOTEDIALER_PROXY_VERSION=${CATTLE_REMOTEDIALER_PROXY_VERSION}")
BUILD_ARGS+=("--build-arg=CATTLE_RANCHER_TURTLES_VERSION=${CATTLE_RANCHER_TURTLES_VERSION}")
BUILD_ARGS+=("--build-arg=CATTLE_CSP_ADAPTER_MIN_VERSION=${CATTLE_CSP_ADAPTER_MIN_VERSION}")
BUILD_ARGS+=("--build-arg=CATTLE_FLEET_VERSION=${CATTLE_FLEET_VERSION}")
BUILD_ARGS+=("--build-arg=CATTLE_RANCHER_PROVISIONING_CAPI_VERSION=${CATTLE_RANCHER_PROVISIONING_CAPI_VERSION}")

BUILD_ACTION="${BUILD_ACTION:-"--load"}"

if [ "$TARGET" = "server" ]; then
  docker buildx build \
    "${BUILD_ARGS[@]}" \
    "${LABELS[@]}" \
    --build-arg VERSION="$TAG" \
    --build-arg COMMIT="$COMMIT" \
    --build-arg ARCH="$ARCH" \
    --build-arg CATTLE_RANCHER_WEBHOOK_VERSION="$CATTLE_RANCHER_WEBHOOK_VERSION" \
    --build-arg CATTLE_REMOTEDIALER_PROXY_VERSION="$CATTLE_REMOTEDIALER_PROXY_VERSION" \
    --build-arg CATTLE_CSP_ADAPTER_MIN_VERSION="$CATTLE_CSP_ADAPTER_MIN_VERSION" \
    --build-arg CATTLE_FLEET_VERSION="$CATTLE_FLEET_VERSION" \
    --build-arg CATTLE_RANCHER_PROVISIONING_CAPI_VERSION="$CATTLE_RANCHER_PROVISIONING_CAPI_VERSION" \
    ${BUILD_ACTION} \
    $(LABELS) \
    --target "server" \
    --tag "$TAG-linux-$ARCH" \
    --file package/Dockerfile .
fi
