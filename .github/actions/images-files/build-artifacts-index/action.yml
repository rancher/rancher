name: "Build the artifacts index"
description: "Build and upload the artifacts index and invalidate the cloudfront cache"
runs:
  using: "composite"
  steps:
    - id: vars
      name: set up variables
      shell: bash
      run: |
        echo "ARTIFACTS_INDEX=${{ runner.temp }}/artifacts-index" >> $GITHUB_OUTPUT
    - name: setup ecm-distro-tools
      uses: rancher/ecm-distro-tools@3fb58c0204d3fc185516c175b6c58adc3089bb86 # v0.55.0
    - name: Build Artifacts Index
      shell: bash
      run: |
        mkdir -p ${{ steps.vars.outputs.ARTIFACTS_INDEX }}
        # The generate artifacts-index command needs an aws key and secret to perform operations, but all other auth configs are not used
        # The config is generated using the config gen command to prevent future changes in the config format from breaking this command
        ECM_AUTH_CONFIG=$(release config gen | jq '.auth | .aws_access_key_id |= "${{ env.AWS_ACCESS_KEY_ID }}" | .aws_secret_access_key |= "${{ env.AWS_SECRET_ACCESS_KEY }}" | .aws_session_token |= "" | .aws_default_region |= "${{ env.AWS_DEFAULT_REGION }}"')
        ECM_CONFIG="{\"auth\": $ECM_AUTH_CONFIG}"
        # ignore v2.6.4 because it isn't a prime version, but it needs to be in the bucket since it is used by a test
        release generate rancher artifacts-index --config "$ECM_CONFIG" --write-path ${{ steps.vars.outputs.ARTIFACTS_INDEX }} --ignore-versions v2.6.4
    - name: Upload Artifacts Index
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ env.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ env.AWS_SECRET_ACCESS_KEY }}
        ARTIFACTS_BUCKET_NAME: ${{ env.ARTIFACTS_BUCKET_NAME }}
      run: |
        aws s3 cp ${{ steps.vars.outputs.ARTIFACTS_INDEX }}/index.html s3://${{ env.ARTIFACTS_BUCKET_NAME }}/index.html
        aws s3 cp ${{ steps.vars.outputs.ARTIFACTS_INDEX }}/index-prerelease.html s3://${{ env.ARTIFACTS_BUCKET_NAME }}/index-prerelease.html
    - name: Invalidate Cloudfront cache
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ env.AWS_ACCESS_KEY_ID_CACHE_INVALIDATION }}
        AWS_SECRET_ACCESS_KEY: ${{ env.AWS_SECRET_ACCESS_KEY_CACHE_INVALIDATION }}
        ARTIFACTS_DISTRIBUTION_ID: ${{ env.ARTIFACTS_DISTRIBUTION_ID }}
      run: |
        aws cloudfront create-invalidation --distribution-id ${{ env.ARTIFACTS_DISTRIBUTION_ID }} --paths "/*"

